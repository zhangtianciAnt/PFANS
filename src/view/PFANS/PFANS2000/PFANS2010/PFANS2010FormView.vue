<template>
  <div>
    <EasyNormalContainer
      :buttonList="buttonList"
      :title="title"
      @buttonClick="buttonClick"
      @disabled="setdisabled"
      ref="container"
      v-loading="loading"
      :defaultStart="defaultStart"
      @workflowState="workflowState"
      :workflowCode="workflowCode"
      @StartWorkflow="checkWorkFlow"
    >
      <div slot="customize">
    <EasyNormalTable
                     :columns="columns"
                     :data="data"
                     :rowid="row_id"
                     @rowClick="rowClick"
                     :showSelection="showSelection"
                     :selectable="selectable" :rowClassName="rowClassName"
    ref="table">
    </EasyNormalTable>
      </div>
    </EasyNormalContainer>
  </div>
</template>

<script>
    import EasyNormalTable from '@/components/EasyNormalTable/index2.vue';
    import {Message} from 'element-ui';
    import moment from "moment";
    import EasyNormalContainer from '@/components/EasyNormalContainer';
    import {getUserInfo, getDictionaryInfo} from "../../../../utils/customize";

    export default {
        name: 'PFANS2010FormView',
        components: {
            EasyNormalTable,
          EasyNormalContainer
        },
        data() {
            return {
              defaultStart:false,
              showSelection:true,
              uplist:[],
                dateInfo: [],
                disdateflg: '',
                loading: false,
                exitdate: '',
                workflowCode: '',
                title: 'title.PFANS2010FOMRVIEW',
                data: [],
                rowid: '',
                row_id: 'attendance_id',
                form: {
                    attendanceid: '',
                    recognitionstate: '1',
                },
                columns: [
                    {
                        code: 'dates',
                        label: 'label.PFANS2010VIEW_APPLICATION',
                        labelClass: 'pfans2010view_column_1',
                        width: 100,
                        fix: false,
                        filter: true,
                    },
                    {
                        code: 'SERVICE',
                        label: 'label.PFANS2010VIEW_SERVICE',
                        labelClass: 'pfans2010view_column_2',
                        child: [
                            {
                                code: 'normal',
                                label: 'label.PFANS2010VIEW_NORMAL',
                                labelClass: 'pfans2010view_column_3',
                              width: 90,
                                fix: false,
                                filter: true,
                            }, {
                                code: 'ordinaryindustry',
                                label: 'label.PFANS2010VIEW_OVERTIME',
                                labelClass: 'pfans2010view_column_3',
                            width: 90,
                                fix: false,
                                filter: true,
                            }, {
                                code: 'weekendindustry',
                                label: 'label.PFANS2010VIEW_RETIREMENT',
                                labelClass: 'pfans2010view_column_3',
                            width: 90,
                                fix: false,
                                filter: true,
                            }, {
                                code: 'statutoryresidue',
                                label: 'label.PFANS2010VIEW_HOLIDAYS',
                                labelClass: 'pfans2010view_column_3',
                            width: 90,
                                fix: false,
                                filter: true,
                            }, {
                                code: 'annualrestday',
                                label: 'label.PFANS2010VIEW_EVERYYEAR',
                                labelClass: 'pfans2010view_column_3',
                            width: 110,
                                fix: false,
                                filter: true,
                            }, {
                                code: 'specialday',
                                label: 'label.PFANS2010VIEW_OCCASIONS',
                                labelClass: 'pfans2010view_column_3',
                            width: 110,
                                fix: false,
                                filter: true,
                            }, {
                                code: 'youthday',
                                label: 'label.PFANS2010VIEW_YOUTHDAY',
                                labelClass: 'pfans2010view_column_3',
                            width: 100,
                                fix: false,
                                filter: true,
                            }, {
                                code: 'womensday',
                                label: 'label.PFANS2010VIEW_WOMENSDAY',
                                labelClass: 'pfans2010view_column_3',
                            width: 100,
                                fix: false,
                                filter: true,
                            },
                        ],
                    },
                    {
                        code: 'annualrest',
                        label: 'label.PFANS2010VIEW_INHUGH',
                        labelClass: 'pfans2010view_column_6',
                      width: 90,
                        fix: false,
                        filter: true,
                    },
                    {
                        code: 'daixiu',
                        label: 'label.PFANS2010VIEW_DAYOFF',
                        labelClass: 'pfans2010view_column_6',
                      width: 90,
                        fix: false,
                        filter: true,
                    },
                  {
                    code: 'welfare',
                    label: 'label.PFANS2010VIEW_WELFARE',
                    labelClass: 'pfans2010view_column_6',
                    width: 100,
                    fix: false,
                    filter: true,
                  },
                  {
                    code: 'SICKLEAVE',
                    label: 'label.PFANS2010VIEW_SICKLEAVE',
                    labelClass: 'pfans2010view_column_4',
                    child: [
                      {
                        code: 'shortsickleave',
                        label: 'label.PFANS2010VIEW_SHORT',
                        labelClass: 'pfans2010view_column_5',
                        width: 100,
                        fix: false,
                        filter: true,
                      },
                      {
                        code: 'longsickleave',
                        label: 'label.PFANS2010VIEW_LONG',
                        labelClass: 'pfans2010view_column_5',
                        width: 100,
                        fix: false,
                        filter: true,
                      },
                    ],
                  },
                  {
                    code: 'compassionateleave',
                    label: 'label.PFANS2010VIEW_LEAVE',
                    labelClass: 'pfans2010view_column_7',
                    width: 90,
                    fix: false,
                    filter: true,
                  },
                  {
                    code: 'nursingleave',
                    label: 'label.PFANS2010VIEW_MATERNITY',
                    labelClass: 'pfans2010view_column_7',
                    width: 110,
                    fix: false,
                    filter: true,
                  },
                    {
                        code: 'absenteeism',
                        label: 'label.PFANS2010VIEW_ABSENCE',
                        labelClass: 'pfans2010view_column_7',
                      width: 90,
                        fix: false,
                        filter: true,
                    },
                    {
                        code: 'recognitionstate',
                        label: 'label.PFANS2010VIEW_RECOGNITION',
                        labelClass: 'pfans2010view_column_9',
                      width: 110,
                        fix: false,
                        filter: true,
                    },
                ],
              totalAbsenteeism:false,
                buttonList: [
                    {'key': 'recognition', 'name': 'button.recognition', 'disabled': false, 'icon': 'el-icon-check'}
                ],
            };
        },
      methods: {
          checkWorkFlow(){
            //考勤是否全部承认
            let count = 0
            for(let item of this.data){
              if (item.recognitionstate === '承认' || item.recognitionstate === '') {
                count = count +1
              }
            }

            if(count != this.data.length - 1){
              Message({
                message: "承认考勤后，才可发起审批！",
                type: 'error',
                duration: 5 * 1000
              });
            }else{
              this.$refs.container.$refs.workflow.startWorkflow();
            }
          },
          selectable(row, index){
            if(index != 0 && row.recognitionstate === this.$t('label.PFANS2010VIEW_RECOGNITION0')){
              return true;
            }else{
              return false;
            }
          },
          //add-ws-考勤设置休日背景色
          getDay() {
            this.$store
              .dispatch('PFANS8007Store/getList', {})
              .then(response => {
                for (let i = 0; i < response.length; i++) {
                  if(moment(response[i].workingdate).format('MM')===this.$route.params._id.split(",")[2]){
                    this.dateInfo.push({
                      dateflg: moment(response[i].workingdate).format('YYYY-MM-DD'),
                      type: response[i].type,
                    });
                  }
                }
              });
          },
          //add-ws-考勤设置休日背景色
          rowClassName({row, rowIndex}){
            //add-ws-考勤设置休日背景色

            for(let i =0;i<this.dateInfo.length;i++){
              if(this.dateInfo[i].type === '4'){
                if(this.dateInfo[i].dateflg === row.dates){
                  return "white";
                }
              }else{
                if(this.dateInfo[i].dateflg === row.dates){
                  row.absenteeism = "";
                  this.totalAbsenteeism = true;
                  return "sub_bg_color_Darkgrey";
                }
              }
            }

            //ccm 入职离职后考勤颜色   from
            let userid = this.$route.params._id.split(",")[0];
            let user = getUserInfo(userid);
            let resignationdate ='';
            let enterdate ='';
            if (user) {
              resignationdate = user.userinfo.resignation_date;
              enterdate = user.userinfo.enterday;
            }
            //入职
            if (moment(row.dates).format('YYYY-MM-DD') < moment(enterdate).format('YYYY-MM-DD'))
            {
              if (row.dates ===this.$t('label.PFANS1012VIEW_ACCOUNT'))
              {
                return "white";
              }
              else
              {
                row.absenteeism = "";
                this.totalAbsenteeism = true;
                return "sub_bg_color_Ral";
              }
            }
            //离职
            if (moment(row.dates).format('YYYY-MM-DD') > moment(resignationdate).format('YYYY-MM-DD'))
            {
              if (row.dates ===this.$t('label.PFANS1012VIEW_ACCOUNT'))
              {
                return "white";
              }
              else
              {
                row.absenteeism = "";
                this.totalAbsenteeism = true;
                return "sub_bg_color_Ral";
              }
            }
            //ccm 入职离职后考勤颜色   to

            //add-ws-考勤设置休日背景色
            if(moment(row.dates).format("E") == 6 || moment(row.dates).format("E") == 7 ){
              row.absenteeism = "";
              this.totalAbsenteeism = true;
              return "sub_bg_color_Darkgrey";
            }
          },
          setdisabled(val){
            if(this.$route.params.disabled){
              this.disabled = val;
            }
          },
            rowClick(row) {
                this.rowid = row.attendanceid;

            },
            //add_fjl_05/13   --添加审批正常结束后，自动变成承认状态
            workflowState(val) {
                if (val.state === '1') {
                    this.form.status = '3';
                    this.updStatus1();
                } else if (val.state === '2') {
                    this.form.status = '4';
                    this.updStatus();
                }
            },
            updStatus() {
                if (this.$route.params._id !== null && this.$route.params._id !== '') {
                    let us = this.$route.params._id.split(",");
                    this.form.user_id = us[0];
                    this.form.years = us[1];
                    this.form.months = us[2];
                }
                this.loading = true;
                this.$store
                    .dispatch('PFANS2010Store/updStatus', this.form)
                    .then(response => {
                        this.loading = false;
                        this.data = response;
                    })
                    .catch(error => {
                        Message({
                            message: error,
                            type: 'error',
                            duration: 5 * 1000
                        });
                        this.loading = false;
                    })
            },
            //add_fjl_05/13   --添加审批正常结束后，自动变成承认状态

            // add 0622 ccm --审批被驳回后，当月考勤数据全部变为未承认状态
            updStatus1() {
              if (this.$route.params._id !== null && this.$route.params._id !== '') {
                let us = this.$route.params._id.split(",");
                this.form.user_id = us[0];
                this.form.years = us[1];
                this.form.months = us[2];
              }
              this.loading = true;
              this.$store
                .dispatch('PFANS2010Store/updStatus1', this.form)
                .then(response => {
                  this.loading = false;
                  this.data = response;
                })
                .catch(error => {
                  Message({
                    message: error,
                    type: 'error',
                    duration: 5 * 1000
                  });
                  this.loading = false;
                })
            },
            // add 0622 ccm --审批被驳回后，当月考勤数据全部变为未承认状态
            buttonClick(val) {
                this.$store.commit('global/SET_HISTORYURL', this.$route.path)
                if (val === 'back') {
                    this.$router.push({
                        name: 'PFANS2010View',
                    });
                }
                else if (val === 'recognition') {
                    if (this.$refs.table.selectedList.length === 0) {
                        Message({
                            message: this.$t('normal.info_01'),
                            type: 'info',
                            duration: 2 * 1000
                        });
                        return;
                    }
                    let letexitdate = "0";
                    this.exitdate = getUserInfo(this.$route.params._id.split(",")[0]).userinfo.resignation_date;
                    if(this.exitdate != ""){
                        if (moment(this.exitdate).format("YYYY-MM") === moment(new Date()).format('YYYY-MM')) {
                            letexitdate = "1";
                        }
                    }
                    let dic = getDictionaryInfo("PR064001");
                    if (dic !== null) {
                        if(moment(new Date()).format('DD') >= Number(dic.value1)){
                            if (moment(new Date()).format('MM') === moment(this.disdateflg).format("MM")){
                                if(letexitdate === "0"){
                                    Message({
                                        message: this.$t('label.PFANS2010VIEW_RECOGNITIONDAYERR'),
                                        type: 'error',
                                        duration: 2 * 1000
                                    });
                                    return;
                                }
                            }
                        }
                        else{
                            if(letexitdate === "0"){
                                Message({
                                    message: this.$t('label.PFANS2010VIEW_PLEASE') + dic.value1 + this.$t('label.PFANS2010VIEW_ADMIT'),
                                    type: 'error',
                                    duration: 2 * 1000
                                });
                                return;
                            }
                        }
                    }
                    this.loading = true;
                    this.uplist = this.$refs.table.selectedList;
                    this.update(0);

                }
            },
          update(val){
            this.form.attendanceid = this.uplist[val].attendanceid;
            val = val + 1;
            this.$store
              .dispatch('PFANS2010Store/update', this.form)
              .then(response => {
                if(val < this.uplist.length){
                  this.update(val);
                }else{
                  this.data = response;
                  this.getAttendancelist();
                  this.loading = false;
                  Message({
                    message: this.$t('normal.success_02'),
                    type: 'success',
                    duration: 5 * 1000,
                  });

                  this.$refs.table.$refs.eltable.clearSelection();
                }
              })
              .catch(error => {
                Message({
                  message: error,
                  type: 'error',
                  duration: 5 * 1000
                });
                this.loading = false;
              })
          },
            getAttendancelist() {
                let parameter = {
                    user_id:this.$route.params._id.split(",")[0],
                    years:this.$route.params._id.split(",")[1],
                    months:this.$route.params._id.split(",")[2],
                }
                this.loading = true;
                this.$store
                    .dispatch('PFANS2010Store/getAttendancelist1', parameter)
                    .then(response => {

                      for (let j = 0; j < response.length; j++) {
                          // response[j].dates = moment(response[j].dates).format("YYYY-MM-DD");
                          this.disdateflg = response[0].dates;
                          if(response[j].recognitionstate === "0"){
                              if (this.$i18n) {
                                  response[j].recognitionstate = this.$t('label.PFANS2010VIEW_RECOGNITION0');
                              }
                          }
                          else if(response[j].recognitionstate === "1"){
                              if (this.$i18n) {
                                  response[j].recognitionstate = this.$t('label.PFANS2010VIEW_RECOGNITION1');
                              }
                          }
                          //add ccm
                          if(response[j].absenteeism === null || response[j].absenteeism === "")
                          {
                              response[j].absenteeism = response[j].tabsenteeism;
                          }
                          //add ccm
                          if(response[j].shortsickleave === null || response[j].shortsickleave === "")
                          {
                              response[j].shortsickleave = response[j].tshortsickleave;
                          }
                          if(response[j].longsickleave === null || response[j].longsickleave === "")
                          {
                              response[j].longsickleave = response[j].tlongsickleave;
                          }

                      }

                      if (this.$route.params._id.split(",")[0] === '5e78fefff1560b363cdd6db7')
                      {
                        this.$store.commit('global/SET_WORKFLOWURL', '');
                      }

                      let res = [];
                      let res1 = [];
                      let yearMonth = moment(Date.parse(this.$route.params._id.split(",")[1] + '-' + this.$route.params._id.split(",")[2] +'-01'));
                      let start = moment(yearMonth).startOf('month');
                      let end = moment(yearMonth).endOf('month');

                      for(let day = start;day <= end;day.add(1,'d')){
                        let daydata = response.filter(item => moment(item.dates).format("YYYY-MM-DD") === moment(day).format("YYYY-MM-DD"))
                        if(daydata.length > 0){
                          daydata[0].dates = moment(daydata[0].dates).format("YYYY-MM-DD")
                          res.push(daydata[0]);
                        }
                      //del ccm
                      // else{
                      //     res.push({
                      //       dates:moment(day).format("YYYY-MM-DD"),
                      //       absenteeism:8
                      //     });
                      //   }
                      //del ccm
                      }

                      //add CCM 合计行--from
                      var total_normal = 0;
                      var total_ordinaryindustry = 0;
                      var total_weekendindustry = 0;
                      var total_statutoryresidue = 0;
                      var total_annualrestday = 0;
                      var total_specialday = 0;
                      var total_youthday = 0;
                      var total_womensday = 0;
                      var total_annualrest = 0;
                      var total_daixiu = 0;
                      var total_welfare = 0;
                      var total_shortsickleave = 0;
                      var total_longsickleave = 0;
                      var total_compassionateleave = 0;
                      var total_nursingleave = 0;
                      var total_absenteeism = 0;

                      for (var i =0; i < res.length; i ++)
                      {
                        total_normal += parseFloat(res[i]["normal"] === undefined ? '0' :(res[i]["normal"] ===null || res[i]["normal"] ==='' ? '0':res[i]["normal"]));
                        total_ordinaryindustry += parseFloat(res[i]["ordinaryindustry"] ===undefined ? '0' :(res[i]["ordinaryindustry"]===null || res[i]["ordinaryindustry"]==='' ? '0':res[i]["ordinaryindustry"]));
                        total_weekendindustry += parseFloat(res[i]["weekendindustry"] ===undefined ? '0' :(res[i]["weekendindustry"]===null ||  res[i]["weekendindustry"]==='' ? '0':res[i]["weekendindustry"]));
                        total_statutoryresidue += parseFloat(res[i]["statutoryresidue"] ===undefined ? '0' :(res[i]["statutoryresidue"]===null || res[i]["statutoryresidue"]==='' ? '0':res[i]["statutoryresidue"]));
                        total_annualrestday += parseFloat(res[i]["annualrestday"] ===undefined ? '0' :(res[i]["annualrestday"]===null || res[i]["annualrestday"]=== '' ? '0':res[i]["annualrestday"]));
                        total_specialday += parseFloat(res[i]["specialday"] ===undefined ? '0' :(res[i]["specialday"]===null || res[i]["specialday"]=== '' ? '0':res[i]["specialday"]));
                        total_youthday += parseFloat(res[i]["youthday"] ===undefined ? '0' :(res[i]["youthday"]===null || res[i]["youthday"]=== '' ? '0':res[i]["youthday"]));
                        total_womensday += parseFloat(res[i]["womensday"] ===undefined ? '0' :(res[i]["womensday"]===null || res[i]["womensday"]==='' ? '0':res[i]["womensday"]));
                        total_annualrest += parseFloat(res[i]["annualrest"] ===undefined ? '0' :(res[i]["annualrest"]===null || res[i]["annualrest"]==='' ? '0':res[i]["annualrest"]));
                        total_daixiu += parseFloat(res[i]["daixiu"] ===undefined ? '0' :(res[i]["daixiu"]===null || res[i]["daixiu"]==='' ? '0':res[i]["daixiu"]));
                        total_welfare += parseFloat(res[i]["welfare"] ===undefined ? '0' :(res[i]["welfare"]===null || res[i]["welfare"]==='' ? '0':res[i]["welfare"]));
                        total_shortsickleave += parseFloat(res[i]["shortsickleave"] ===undefined ? '0' :(res[i]["shortsickleave"]===null || res[i]["shortsickleave"]==='' ? '0':res[i]["shortsickleave"]));
                        total_longsickleave += parseFloat(res[i]["longsickleave"] ===undefined ? '0' :(res[i]["longsickleave"]===null || res[i]["longsickleave"]==='' ? '0':res[i]["longsickleave"]));
                        total_compassionateleave += parseFloat(res[i]["compassionateleave"] ===undefined ? '0' :(res[i]["compassionateleave"]===null || res[i]["compassionateleave"]==='' ? '0':res[i]["compassionateleave"]));
                        total_nursingleave += parseFloat(res[i]["nursingleave"] ===undefined ? '0' :(res[i]["nursingleave"]===null || res[i]["nursingleave"]==='' ?  '0':res[i]["nursingleave"]));
                        total_absenteeism += parseFloat(res[i]["absenteeism"] ===undefined ? '0' :(res[i]["absenteeism"]===null || res[i]["absenteeism"]==='' ? '0':res[i]["absenteeism"]));
                      }
                      res1.push( {dates: '合计',
                                                                    normal: total_normal,
                                                                    ordinaryindustry: total_ordinaryindustry,
                                                                    weekendindustry: total_weekendindustry,
                                                                    statutoryresidue: total_statutoryresidue,
                                                                    annualrestday: total_annualrestday,
                                                                    specialday: total_specialday,
                                                                    youthday: total_youthday,
                                                                    womensday: total_womensday,
                                                                    annualrest: total_annualrest,
                                                                    daixiu: total_daixiu,
                                                                    welfare: total_welfare,
                                                                    shortsickleave: total_shortsickleave,
                                                                    longsickleave: total_longsickleave,
                                                                    compassionateleave: total_compassionateleave,
                                                                    nursingleave: total_nursingleave,
                                                                    absenteeism: total_absenteeism,
                                                                    recognitionstate: null
                      });
                      for (var k =0 ; k<res.length;k++)
                      {
                        res1.push(res[k]);
                      }

                      //add CCM 合计行--end
                      this.data = res1;
                      this.loading = false;
                    })
                    .catch(error => {
                        Message({
                            message: error,
                            type: 'error',
                            duration: 5 * 1000,
                        });
                        this.loading = false;
                    });
            },
        },
        mounted() {
            //ADD_FJL_05/14
            if (this.$route.params._id !== null && this.$route.params._id !== '') {
                let us = this.$route.params._id.split(",");
                let userid = us[0];
                this.$store
                    .dispatch('personalCenterStore/getPersonalCenterinfo', {"userid": userid})
                    .then(response => {
                        let roles = "";
                        let num = 0;
                        if (response.userAccount && response.userAccount.roles && response.userAccount.roles.length > 0) {
                            for (let role of response.userAccount.roles) {
                                roles = roles + role.description;
                            }
                            if (roles.indexOf("总经理") != -1) {
                                num++
                            } else if (roles.toUpperCase().indexOf("CENTER") != -1) {
                                num++
                            } else if (roles.toUpperCase().indexOf("GM") != -1) {
                                num++
                            } else if (roles.toUpperCase().indexOf("TL") != -1) {
                                num++
                            }
                        }

                        if (num === 0) {
                            //普通社員审批
                            this.workflowCode = 'W0002'
                        } else {
                            //领导审批
                            this.workflowCode = 'W0069'
                        }
                    });
            }
            //ADD_FJL_05/14
          //add-ws-考勤设置休日背景色
          this.getDay();
          //add-ws-考勤设置休日背景色
            this.getAttendancelist();
            // this.$store.commit('global/SET_OPERATEID', '');
        },
      watch:{
        data:{
          handler(val) {
            if(this.totalAbsenteeism){
              let total = 0;
              for(let item of val){
                if(item.dates === '合计'){
                  continue;
                }

                total = total+ Number(item.absenteeism)
              }

              if(total > 0){
                val[0].absenteeism = total;
              }
            }

            this.totalAbsenteeism = false;
          },
          immediate: true,  //刷新加载 立马触发一次handler
          deep: true,
        }
      }
    };
</script>

<style lang="scss" rel="stylesheet/scss">
  .pfans2010view_column_1 {
    height: 81px;
    background: #425E72;
    color: #ffffff;
  }
  .pfans2010view_column_2 {
    height: 40px;
    background: #5CBFA3;
    color: #ffffff;
    text-align: center;
  }
  .pfans2010view_column_3 {
    height: 40px;
    background: #AEDFD1;
    color: #ffffff;
  }
  .pfans2010view_column_4 {
    height: 40px;
    background: #2696C3;
    color: #ffffff;
    text-align: center;
  }

  .pfans2010view_column_5 {
    height: 40px;
    background: #93CBE1;
    color: #ffffff;
  }
  .pfans2010view_column_6 {
    height: 81px;
    background: #F2BC6A;
    color: #ffffff;
  }
  .pfans2010view_column_7 {
    height: 81px;
    background: #E5575E;
    color: #ffffff;
  }
  .pfans2010view_column_8 {
    height: 40px;
    background: #F2ABAF;
    color: #ffffff;
  }
  .pfans2010view_column_9 {
    height: 81px;
    background: #CCCCCC;
    color: #ffffff;
  }
</style>

