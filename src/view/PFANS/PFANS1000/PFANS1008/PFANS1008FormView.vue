<template>
  <div style="min-height: 100%">
    <EasyNormalContainer ref="container" v-loading="loading" :buttonList="buttonList" :canStart="canStart"
                         :title="title" :userlist="userlistLc" :workflowCode="workflowCode"
                         @buttonClick="buttonClick" @end="end" @start="start" @workflowState="workflowState">
      <div slot="customize">
        <el-form ref="refform" :model="form" :rules="rules" label-position="top" label-width="8vw"
                 style="padding: 2vw">
          <el-collapse v-model="activeNames">
            <el-collapse-item name="1">
              <template slot="title">
                <span class="collapse_Title">{{ $t('title.PFANS1008VIEW') }}</span>
              </template>
              <el-row>
                <!--PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc start-->
                <el-col :span="8">
                  <el-form-item :label="$t('label.center')">
                    <el-input v-model="centerid" :disabled="true" style="width:20vw"></el-input>
                    <el-input v-show='false' v-model="form.center_id" :disabled="true" style="width:20vw"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :label="$t('label.group')">
                    <el-input v-model="groupid" :disabled="true" style="width:20vw"></el-input>
                    <el-input v-show='false' v-model="form.group_id" :disabled="true" style="width:20vw"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :label="$t('label.team')">
                    <el-input v-model="teamid" :disabled="true" style="width:20vw"></el-input>
                    <el-input v-show='false' v-model="form.team_id" :disabled="true" style="width:20vw"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <!--//PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc end-->
                  <el-form-item :error="erroruser" :label="$t('label.applicant')" prop="user_id">
                    <user :disabled="true" :error="erroruser" :selectType="selectType" :userlist="userlist"
                          style="width: 20vw" @getUserids="getUserids"></user>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :label="$t('label.PFANS1008FORMVIEW_INSIDENUMBER')" prop="insidenumber">
                    <el-input v-model="form.insidenumber" :disabled="!disabled" maxlength='20'
                              style="width:20vw"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :label="$t('label.PFANS1008FORMVIEW_MOBILEDAY')" prop="mobiledate">
                    <el-date-picker v-model="form.mobiledate" :disabled="!disabled" style="width:20vw"
                                    type="date"></el-date-picker>
                  </el-form-item>
                </el-col>
              </el-row>
            </el-collapse-item>
          </el-collapse>
          <el-collapse>
            <el-collapse-item>
              <template slot="title">
                <span class="collapse_Title">{{ $t('label.PFANS1008FORMVIEW_CROSSINGDEPARTMENT') }}</span>
              </template>

              <el-row>
                <el-col :span="8">
                  <el-form-item :label="$t('label.team')">
                    <org :disabled="true" :orglist="form.ferryteam_id" orgtype="3" style="width:20vw"
                         @getOrgids="getTeamId1"></org>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :error="errorferrygroup" :label="$t('label.group')" prop="ferrygroup_id">
                    <org :disabled="!disabled" :error="errorferrygroup" :orglist="form.ferrygroup_id" orgtype="2"
                         style="width:20vw" @getOrgids="getGroupId1"></org>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :error="errorferrycenter" :label="$t('label.center')" prop="ferrycenter_id">
                    <org :disabled="!disabled" :error="errorferrycenter" :orglist="form.ferrycenter_id" orgtype="1"
                         style="width:20vw" @getOrgids="getCenterId1"></org>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :label="$t('label.PFANS1012FORMVIEW_BUDGET')" prop="ferrybudgetunit">
                    <!--                <el-input :disabled="true" style="width:20vw" v-model="form.ferrybudgetunit" maxlength='50'></el-input>-->
                    <el-input v-model="form.ferrybudgetunit" :disabled="true" style="width:20vw"></el-input>
                    <!--                    <el-select clearable style="width: 20vw" v-model="form.ferrybudgetunit" :disabled="!disabled"-->
                    <!--                               :placeholder="$t('normal.error_09')">-->
                    <!--                      <el-option-->
                    <!--                        v-for="item in options"-->
                    <!--                        :key="item.value"-->
                    <!--                        :label="item.lable"-->
                    <!--                        :value="item.value"-->
                    <!--                        @change="changeBut">-->
                    <!--                      </el-option>-->
                    <!--                    </el-select>-->
                  </el-form-item>
                </el-col>
              </el-row>
            </el-collapse-item>
          </el-collapse>
          <el-collapse>
            <el-collapse-item>
              <template slot="title">
                <span class="collapse_Title">{{ $t('label.PFANS1008FORMVIEW_TRANSFERDEPARTMENT') }}</span>
              </template>

              <el-row>
                <!--//PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc start-->
                <el-col :span="8">
                  <el-form-item :label="$t('label.team')">
                    <org :disabled="true" :orglist="form.tubeteam_id" orgtype="3" style="width:20vw"
                         @getOrgids="getTeamId2"></org>
                  </el-form-item>
                </el-col>
                <!--//PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc end-->
                <el-col :span="8">
                  <el-form-item :error="errortubegroup" :label="$t('label.group')" prop="tubegroup_id">
                    <org :disabled="!disabled" :error="errortubegroup" :orglist="form.tubegroup_id" orgtype="2"
                         style="width:20vw" @getOrgids="getGroupId2"></org>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <el-form-item :error="errortubecenter" :label="$t('label.center')" prop="tubecenter_id">
                    <org :disabled="!disabled" :error="errortubecenter" :orglist="form.tubecenter_id" orgtype="1"
                         style="width:20vw" @getOrgids="getCenterId2"></org>
                  </el-form-item>
                </el-col>
                <el-col :span="8">
                  <!--                  <el-form-item :label="$t('label.budgetunit')" prop="tubebudgetunit">-->
                  <el-form-item :label="$t('label.budgetunit')">
                    <el-input v-model="form.tubebudgetunit" :disabled="true" style="width:20vw"></el-input>
                    <!--                    <el-select clearable style="width: 20vw" v-model="form.tubebudgetunit" :disabled="!disabled"-->
                    <!--                               :placeholder="$t('normal.error_09')">-->
                    <!--                      <el-option-->
                    <!--                        v-for="item in options1"-->
                    <!--                        :key="item.value"-->
                    <!--                        :label="item.lable"-->
                    <!--                        :value="item.value"-->
                    <!--                        @change="getTubebudgetunit">-->
                    <!--                      </el-option>-->
                    <!--                    </el-select>-->
                  </el-form-item>
                </el-col>
              </el-row>

              <el-row>
                <el-table :data="tableD" border header-cell-class-name="sub_bg_color_blue" stripe>
                  <el-table-column :label="$t('label.PFANS2006VIEW_NO')" fixed type="index"></el-table-column>
                  <el-table-column :label="$t('label.PFANS1008FORMVIEW_ASSETMANAGEMENTNUMBER')" align="center"
                                   width="200">
                    <template slot-scope="scope">
                      <el-input v-model="scope.row.management" :disabled="true" :no="scope.row" maxlength="20">
                      </el-input>
                    </template>
                  </el-table-column>
                  <el-table-column :label="$t('label.PFANS1008FORMVIEW_ASSETNAME')" align="center" width="200">
                    <template slot-scope="scope">
                      <el-input v-model="scope.row.assetname" :disabled="true" :no="scope.row" maxlength="20">
                      </el-input>
                    </template>
                  </el-table-column>
                  <el-table-column :label="$t('label.PFANS1008FORMVIEW_RESPONSIBLEPERSON')" align="center" width="200">
                    <template slot-scope="scope">
                      <user :disabled="true" :no="scope.row" :selectType="selectType" :userlist="scope.row.person"
                            @getUserids="getUseridsperson"></user>
                    </template>
                  </el-table-column>
                  <el-table-column :label="$t('label.PFANS1008FORMVIEW_RESPONSIBLEAFTER')" align="center" width="200">
                    <template slot-scope="scope">
                      <user :disabled="!disabled" :no="scope.row" :selectType="selectType" :userlist="scope.row.eafter"
                            @getUserids="getUseridseafter"></user>
                    </template>
                  </el-table-column>
                  <el-table-column :label="$t('label.PFANS1008FORMVIEW_REASONFORMOVEMENT')" align="center" width="200">
                    <template slot-scope="scope">
                      <el-input v-model="scope.row.reason" :disabled="!disabled" :no="scope.row" maxlength="50">
                      </el-input>
                    </template>
                  </el-table-column>
                  <el-table-column :label="$t('label.operation')" align="center" width="200">
                    <template slot-scope="scope">
                      <el-button
                        :disabled="!disabled"
                        plain
                        size="small"
                        type="danger"
                        @click.native.prevent="deleteRow(scope.$index, tableD)"
                      >{{ $t('button.delete') }}
                      </el-button>
                      <!--<el-button-->
                      <!--:disabled="!disabled"-->
                      <!--@click="addRow()"-->
                      <!--plain-->
                      <!--size="small"-->
                      <!--type="primary"-->
                      <!--&gt;{{$t('button.insert')}}-->
                      <!--</el-button>-->
                    </template>
                  </el-table-column>
                </el-table>
              </el-row>
            </el-collapse-item>
          </el-collapse>
        </el-form>
      </div>
    </EasyNormalContainer>
  </div>
</template>

<script>
import EasyNormalContainer from '@/components/EasyNormalContainer';
import dicselect from '../../../components/dicselect.vue';
import user from '../../../components/user.vue';
import {Message} from 'element-ui';
import {getOrgInfo, getOrgInfoByUserId, getUserInfoName} from '@/utils/customize';
import org from '../../../components/org';
import moment from 'moment';

export default {
  name: 'PFANS1008FormView',
  components: {
    EasyNormalContainer,
    dicselect,
    user,
    org,
  },
  data() {
    var checkuser = (rule, value, callback) => {
      if (!value || value === '') {
        this.erroruser = this.$t('normal.error_09') + this.$t('label.applicant');
        return callback(new Error(this.$t('normal.error_09') + this.$t('label.applicant')));
      } else {
        this.erroruser = '';
        return callback();
      }

    };
    // var checkferrycenter = (rule, value, callback) => {
    //     if(!value || value === ''){
    //         this.errorferrycenter = this.$t('normal.error_09') + this.$t('label.center');
    //         return callback(new Error(this.$t('normal.error_09') + this.$t('label.center')));
    //     }else{
    //         this.errorferrycenter = "";
    //         return callback();
    //     }
    //
    // };
    // var checkferrygroup = (rule, value, callback) => {
    //     if(!value || value === ''){
    //         this.errorferrygroup = this.$t('normal.error_09') + this.$t('label.group');
    //         return callback(new Error(this.$t('normal.error_09') + this.$t('label.group')));
    //     }else{
    //         this.errorferrygroup = "";
    //         return callback();
    //     }
    //
    // };
    // var checktubecenter = (rule, value, callback) => {
    //     if(!value || value === ''){
    //         this.errortubecenter = this.$t('normal.error_09') + this.$t('label.center');
    //         return callback(new Error(this.$t('normal.error_09') + this.$t('label.center')));
    //     }else{
    //         this.errortubecenter = "";
    //         return callback();
    //     }
    //
    // };
    // var checktubegroup = (rule, value, callback) => {
    //     if(!value || value === ''){
    //         this.errortubegroup = this.$t('normal.error_09') + this.$t('label.group');
    //         return callback(new Error(this.$t('normal.error_09') + this.$t('label.group')));
    //     }else{
    //         this.errortubegroup = "";
    //         return callback();
    //     }
    //
    // };
    var checkperson = (rule, value, callback) => {
      if (!value || value === '') {
        this.errorperson = this.$t('normal.error_09') + this.$t('label.person');
        return callback(new Error(this.$t('normal.error_09') + this.$t('label.person')));
      } else {
        this.errorperson = '';
        return callback();
      }

    };
    var checkeafter = (rule, value, callback) => {
      if (!value || value === '') {
        this.erroreafter = this.$t('normal.error_09') + this.$t('label.eafter');
        return callback(new Error(this.$t('normal.error_09') + this.$t('label.eafter')));
      } else {
        this.erroreafter = '';
        return callback();
      }

    };
    var ferrycenterId = (rule, value, callback) => {
      if (!this.form.ferrycenter_id || this.form.ferrycenter_id === '') {
        callback(new Error(this.$t('normal.error_08') + 'center'));
        this.errorferrycenter = this.$t('normal.error_08') + 'center';
      } else {
        callback();
      }
    };
    var ferrygroupId = (rule, value, callback) => {
      if (!this.form.ferrygroup_id || this.form.ferrygroup_id === '') {
        callback(new Error(this.$t('normal.error_08') + 'group'));
        this.errorferrygroup = this.$t('normal.error_08') + 'group';
      } else {
        callback();
      }
    };
    var tubecenterId = (rule, value, callback) => {
      if (!this.form.tubecenter_id || this.form.tubecenter_id === '') {
        callback(new Error(this.$t('normal.error_08') + 'center'));
        this.errortubecenter = this.$t('normal.error_08') + 'center';
      } else {
        callback();
      }
    };
    var tubegroupId = (rule, value, callback) => {
      if (!this.form.tubegroup_id || this.form.tubegroup_id === '') {
        callback(new Error(this.$t('normal.error_08') + 'group'));
        this.errortubegroup = this.$t('normal.error_08') + 'group';
      } else {
        callback();
      }
    };
    return {
      activeNames: ['1'],
      options: [],
      options1: [],
      selectedList: [],
      assetsList: [],
      userlistLc: [],
      centerid: '',
      groupid: '',
      workflowCode: 'W0018',
      teamid: '',
      baseInfo: {},
      // ferrycenterorglist: '',
      // ferrygrouporglist: '',
      // ferryteamorglist: '',
      // tubecenterorglist: '',
      // tubegrouporglist: '',
      // tubeteamorglist: '',
      userlist: '',
      loading: false,
      erroruser: '',
      errorferrycenter: '',
      errorferrygroup: '',
      errortubecenter: '',
      errortubegroup: '',
      errorperson: '',
      erroreafter: '',
      checked: true,
      selectType: 'Single',
      title: 'title.PFANS1008VIEW',
      buttonList: [],
      //PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc start
      workflowAnt: {
        menuUrl: '',
        dataId: '',
      },
      workflowAntDate: [],
      //PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc end
      tabIndex: 0,
      multiple: false,
      form: {
        department: '',
        center_id: '',
        group_id: '',
        team_id: '',
        user_id: '',
        insidenumber: '',
        filename: '',
        mobiledate: moment(new Date()).format('YYYY-MM-DD'),
        ferrycentername: '',
        ferrygroupname: '',
        ferryteamname: '',
        ferrycenter_id: '',
        ferrygroup_id: '',
        ferryteam_id: '',
        tubecentername: '',
        tubegroupname: '',
        tubeteamname: '',
        tubecenter_id: '',
        tubegroup_id: '',
        tubeteam_id: '',
        ferrybudgetunit: '',
        tubebudgetunit: '',
      },
      tableD: [
        {
          notificationid: '',
          softwaretransferid: '',
          management: '',
          assetname: '',
          person: '',
          eafter: '',
          reason: '',
        },
      ],
      code: 'PG002',
      code1: 'PG001',
      disabled: true,
      menuList: [],
      rules: {
        user_id: [
          {
            required: true,
            validator: checkuser,
            trigger: 'change',
          },
        ],
        ferrycenter_id: [
          {
            required: true,
            validator: ferrycenterId,
            trigger: 'change',
          },
        ],
        ferrygroup_id: [
          {
            required: true,
            validator: ferrygroupId,
            trigger: 'change',
          },
        ],
        tubecenter_id: [
          {
            required: true,
            validator: tubecenterId,
            trigger: 'change',
          },
        ],
        tubegroup_id: [
          {
            required: true,
            validator: tubegroupId,
            trigger: 'change',
          },
        ],
        person: [
          {
            required: true,
            validator: checkperson,
            trigger: 'change',
          },
        ],
        eafter: [
          {
            required: true,
            validator: checkeafter,
            trigger: 'change',
          },
        ],
        insidenumber: [
          {
            required: true,
            message: this.$t('normal.error_08') + this.$t('label.PFANS3001VIEW_EXTENSIONNUMBER'),
            trigger: 'change',
          },
        ],
        mobiledate: [
          {
            required: true,
            message: this.$t('normal.error_09') + this.$t('label.PFANS1008FORMVIEW_MOBILEDAY'),
            trigger: 'change',
          },
        ],
        ferrybudgetunit: [
          {
            required: true,
            message: this.$t('normal.error_09') + this.$t('label.budgetunit'),
            trigger: 'change',
          },
        ],
        tubebudgetunit: [
          {
            required: true,
            message: this.$t('normal.error_09') + this.$t('label.budgetunit'),
            trigger: 'change',
          },
        ],
        management: [
          {
            required: true,
            message: this.$t('normal.error_08') + this.$t('label.PFANS1008FORMVIEW_ASSETMANAGEMENTNUMBER'),
            trigger: 'blue',
          },
        ],
        assetname: [
          {
            required: true,
            message: this.$t('normal.error_08') + this.$t('label.PFANS1008FORMVIEW_ASSETNAME'),
            trigger: 'blue',
          },
        ],
        reason: [
          {
            required: true,
            message: this.$t('normal.error_09') + this.$t('label.PFANS1008FORMVIEW_REASONFORMOVEMENT'),
            trigger: 'blue',
          },
        ],
      },
      canStart: false,
    };
  },
  mounted() {
    if (this.$route.params._org) {
      ({
        ferrycentername: this.form.ferrycentername,
        ferrygroupname: this.form.ferrygroupname,
        ferryteamname: this.form.ferryteamname,
        ferrycenter_id: this.form.ferrycenter_id,
        ferrygroup_id: this.form.ferrygroup_id,
        ferryteam_id: this.form.ferryteam_id,
      } = this.$route.params._org);
    }
    if (this.$route.params._org) {
      ({
        tubecentername: this.form.tubecentername,
        tubegroupname: this.form.tubegroupname,
        tubeteamname: this.form.tubeteamname,
        tubecenter_id: this.form.tubecenter_id,
        tubegroup_id: this.form.tubegroup_id,
        tubeteam_id: this.form.tubeteam_id,
      } = this.$route.params._org);
    }
    this.loading = true;
    if (this.$route.params._id) {
      this.$store
        .dispatch('PFANS1008Store/selectById', {'softwaretransferid': this.$route.params._id})
        .then(response => {
          this.form = response.softwaretransfer;
          this.$store.commit('global/SET_OPERATEOWNER', this.form.user_id);
          let rst = getOrgInfoByUserId(response.softwaretransfer.user_id);
          if (rst) {
            this.centerid = rst.centerNmae;
            this.groupid = rst.groupNmae;
            this.teamid = rst.teamNmae;
          }
          this.ferrycenterorglist = this.form.ferrycenter_id;
          this.ferrygrouporglist = this.form.ferrygroup_id;
          this.ferryteamorglist = this.form.ferryteam_id;
          this.tubecenterorglist = this.form.tubecenter_id;
          this.tubegrouporglist = this.form.tubegroup_id;
          this.tubeteamorglist = this.form.tubeteam_id;
          //PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc start
          if (this.form.tubegroup_id != null && this.form.tubegroup_id != '') {
            let groupInfo = getOrgInfo(this.form.tubegroup_id);
            if (groupInfo) {
              this.userlistLc.push(groupInfo.user);
            }
          }
          //PSDCD_PFANS_20210408_XQ_024 新组织变更 ztc start
          //add-ws-7/2-禅道任务192
          this.getFebud(this.form.ferrycenter_id);
          this.getbud(this.form.tubegroup_id);
          //add-ws-7/2-禅道任务192
          if (response.notification.length > 0) {
            this.tableD = response.notification;
          }
          this.userlist = this.form.user_id;
          this.loading = false;
        })
        .catch(error => {
          this.$message.error({
            message: error,
            type: 'error',
            duration: 5 * 1000,
          });
          this.loading = false;
        });
    } else {
      this.tableD = [];
      this.userlist = this.$store.getters.userinfo.userid;
      if (this.userlist !== null && this.userlist !== '') {
        // if(getOrgInfo(getOrgInfoByUserId(this.$store.getters.userinfo.userid).groupId)){
        //     this.form.ferrybudgetunit = getOrgInfo(getOrgInfoByUserId(this.$store.getters.userinfo.userid).groupId).encoding;
        // }
        let rst = getOrgInfoByUserId(this.$store.getters.userinfo.userid);
        if (rst) {
          this.centerid = rst.centerNmae;
          this.groupid = rst.groupNmae;
          this.teamid = rst.teamNmae;
          this.form.center_id = rst.centerId;
          this.form.group_id = rst.groupId;
          this.form.team_id = rst.teamId;
          this.form.ferrycenter_id = rst.centerId;
          this.form.ferrygroup_id = rst.groupId;
          this.form.ferryteam_id = rst.teamId;
        }
        this.form.user_id = this.$store.getters.userinfo.userid;
        this.getFebud(this.form.ferrycenter_id);
      }
      if (this.selectedList != '') {

        this.assetsList = JSON.parse(this.selectedList);
        for (let i = 0; i < this.assetsList.length; i++) {
          var vote = {};
          if (this.assetsList[i].barcode !== null && this.assetsList[i].barcode !== '') {
            vote.management = this.assetsList[i].barcode;
          }
          if (this.assetsList[i].filename !== null && this.assetsList[i].filename !== '') {
            vote.assetname = this.assetsList[i].filename;
          }
          if (this.assetsList[i].principal !== null && this.assetsList[i].principal !== '') {
            let userinfo = getUserInfoName(this.assetsList[i].principal);
            if (userinfo != '-1') {
              vote.person = userinfo.userid;
            }
          }
          this.tableD.push(vote);
        }
      }
      this.loading = false;
    }
  },
  created() {
    this.disabled = this.$route.params.disabled;
    if (this.$route.params._selectedList != null) {
      this.selectedList = this.$route.params._selectedList;
    }
    if (this.disabled) {
      this.buttonList = [
        {
          key: 'save',
          name: 'button.save',
          disabled: false,
          icon: 'el-icon-check',
        },
      ];
    }
  },
  methods: {
    getUserids(val) {
      this.form.user_id = val;
      let rst = getOrgInfoByUserId(val);
      // if(getOrgInfo(getOrgInfoByUserId(val).groupId)){
      //     this.form.ferrybudgetunit = getOrgInfo(getOrgInfoByUserId(val).groupId).encoding;
      // }
      if (rst) {
        this.centerid = rst.centerNmae;
        this.groupid = rst.groupNmae;
        this.teamid = rst.teamNmae;
        this.form.center_id = rst.centerId;
        this.form.group_id = rst.groupId;
        this.form.team_id = rst.teamId;
      } else {
        this.centerid = '';
        this.groupid = '';
        this.teamid = '';
        this.form.center_id = '';
        this.form.group_id = '';
        this.form.team_id = '';
      }
      if (!this.form.user_id || this.form.user_id === '' || val === 'undefined') {
        this.erroruser = this.$t('normal.error_09') + this.$t('label.applicant');
      } else {
        this.erroruser = '';
      }
    },
    getUseridsperson(val, row) {
      row.person = val;
    },
    getUseridseafter(val, row) {
      row.eafter = val;
    },
    getCenterId1(val) {
      this.form.ferrycenter_id = val;
      this.form.ferrybudgetunit = '';
      this.getFebud(val);
      if (!val || this.form.ferrycenter_id === '') {
        this.errorferrycenter = this.$t('normal.error_08') + 'center';
        this.form.ferrygroup_id = '';
      } else {
        this.errorferrycenter = '';
      }
    },
    //转让部門
    getGroupId1(val) {
      this.form.ferrygroup_id = val;
      this.form.ferrybudgetunit = '';
      if (val != '') {
        this.getOrgInformation(val);
        this.getFebud(val);
      } else {
        this.getFebud(this.form.ferrycenter_id);
      }
      if (this.form.ferrycenter_id === '') {
        this.errorferrygroup = this.$t('normal.error_08') + 'center';
      } else {
        this.errorferrygroup = '';
      }
    },
    getTeamId1(val) {
      this.getOrgInformation(val);
      if (this.form.center_id === '') {
        this.errorgroup = this.$t('normal.error_08') + 'center';
      } else {
        this.errorgroup = '';
      }
    },
    //ADD_FJL   修改人员预算编码  --转让部門
    getFebud(val) {
      if (val !== '' && val !== null) {
        this.options = [];
        // if (getOrgInfo(getOrgInfoByUserId(this.$store.getters.userinfo.userid).groupId)) {
        if (getOrgInfo(val)) {
          let butinfo = (getOrgInfo(val).encoding).substring(0, 3);
          let dic = this.$store.getters.dictionaryList.filter(item => item.pcode === 'JY002');
          let dicAnt = dic.filter(item => (item.value2).substring(item.value2.length - 3) == '001');
          let dicLast = dicAnt.filter(item => (item.value1).substring(0, 3) == butinfo);
          if (dicLast.length > 0) {
            // this.options.push({
            //   lable: dicLast[0].value2,
            //   value: dicLast[0].code,
            // });
            this.form.ferrybudgetunit = dicLast[0].value2;
          }
          if (this.options.length === 0) {
            if (getOrgInfo(this.form.ferrygroup_id)) {
              let butinfo = (getOrgInfo(this.form.ferrygroup_id).encoding).substring(0, 3);
              let dic = this.$store.getters.dictionaryList.filter(item => item.pcode === 'JY002');
              let dicAnt = dic.filter(item => (item.value2).substring(item.value2.length - 3) == '001');
              let dicLast = dicAnt.filter(item => (item.value1).substring(0, 3) == butinfo);
              console.log(dicLast);
              if (dicLast.length > 0) {
                // this.options.push({
                //   lable: dicLast[0].value2,
                //   value: dicLast[0].code,
                // });a
                this.form.ferrybudgetunit = dicLast[0].value2;
                // alert(this.form.ferrybudgetunit)
              }
            }
          }
        }
        // }
      } else {
        this.form.ferrybudgetunit = '';
        // this.options = [];
      }
    },
    getFebud1(val) {
      if (val !== '' && val !== null) {
        this.options1 = [];
        // if (getOrgInfo(getOrgInfoByUserId(this.$store.getters.userinfo.userid).groupId)) {
        if (getOrgInfo(val)) {
          let butinfo = (getOrgInfo(val).encoding).substring(0, 3);
          let dic = this.$store.getters.dictionaryList.filter(item => item.pcode === 'JY002');
          let dicAnt = dic.filter(item => (item.value2).substring(item.value2.length - 3) == '001');
          let dicLast = dicAnt.filter(item => (item.value1).substring(0, 3) == butinfo);
          if (dicLast.length > 0) {
            // this.options1.push({
            //   lable: dicLast[0].value2,
            //   value: dicLast[0].code,
            // })
            this.form.tubebudgetunit = dicLast[0].value2;
          }
          if (this.options1.length === 0) {
            let butinfo = (getOrgInfo(this.form.tubegroup_id).encoding).substring(0, 3);
            let dic = this.$store.getters.dictionaryList.filter(item => item.pcode === 'JY002');
            let dicAnt = dic.filter(item => (item.value2).substring(item.value2.length - 3) == '001');
            let dicLast = dicAnt.filter(item => (item.value1).substring(0, 3) == butinfo);
            if (dicLast.length > 0) {
              // this.options1.push({
              //   lable: dicLast[0].value2,
              //   value: dicLast[0].code,
              // });
              this.form.tubebudgetunit = dicLast[0].value2;
            }
          }
        }
        // }
      } else {
        this.form.tubebudgetunit = '';
        // this.options1 = [];
      }
    },
    //ADD_FJL  修改人员预算编码
    getOrgInformation(id) {
      let org = {};
      let treeCom = this.$store.getters.orgs;
      if (id && treeCom.getNode(id)) {
        let node = id;
        let type = treeCom.getNode(id).data.type || 0;
        for (let index = parseInt(type); index >= 1; index--) {
          if (parseInt(type) === index && ![1, 2].includes(parseInt(type))) {
            org.ferrycentername = treeCom.getNode(node).data.departmentname;


            org.ferryteam_id = treeCom.getNode(node).data._id;
          }
          if (index === 2) {
            org.ferrygroupname = treeCom.getNode(node).data.departmentname;
            org.ferrygroup_id = treeCom.getNode(node).data._id;
          }
          if (index === 1) {
            org.ferrycentername = treeCom.getNode(node).data.companyname;
            org.ferrycenter_id = treeCom.getNode(node).data._id;
          }
          node = treeCom.getNode(node).parent.data._id;
        }
        ({
          ferrycentername: this.form.ferrycentername,
          ferrygroupname: this.form.ferrygroupname,
          ferryteamname: this.form.ferryteamname,
          ferrycenter_id: this.form.ferrycenter_id,
          ferrygroup_id: this.form.ferrygroup_id,
          ferryteam_id: this.form.ferryteam_id,
        } = org);
      }
    },
    getOrgInformation2(id) {
      let org = {};
      let treeCom = this.$store.getters.orgs;
      if (id && treeCom.getNode(id)) {
        let node = id;
        let type = treeCom.getNode(id).data.type || 0;
        for (let index = parseInt(type); index >= 1; index--) {
          // if (parseInt(type) === index && ![1, 2].includes(parseInt(type))) {
          //   org.ferrycentername = treeCom.getNode(node).data.departmentname;
          //   org.ferryteam_id = treeCom.getNode(node).data._id;
          // }
          if (index === 2) {
            org.tubegroupname = treeCom.getNode(node).data.departmentname;
            org.tubegroup_id = treeCom.getNode(node).data._id;
          }
          if (index === 1) {
            org.tubecentername = treeCom.getNode(node).data.companyname;
            org.tubecenter_id = treeCom.getNode(node).data._id;
          }
          node = treeCom.getNode(node).parent.data._id;
        }
        ({
          tubecentername: this.form.tubecentername,
          tubegroupname: this.form.tubegroupname,
          // ferryteamname: this.form.ferryteamname,
          tubecenter_id: this.form.tubecenter_id,
          tubegroup_id: this.form.tubegroup_id,
          // ferryteam_id: this.form.ferryteam_id,
        } = org);
      }
    },
    getCenterId2(val) {
      this.form.tubecenter_id = val;
      this.form.tubebudgetunit = '';
      this.getFebud1(val);
      if (!val || this.form.tubecenter_id === '') {
        this.errortubecenter = this.$t('normal.error_08') + 'center';
        this.form.tubegroup_id = '';
      } else {
        this.errortubecenter = '';
      }
    },
    //移管部門
    getGroupId2(val) {
      this.form.tubegroup_id = val;
      this.form.tubebudgetunit = '';
      if (val != '') {
        this.getOrgInformation2(val);
        this.getFebud1(val);
      } else {
        this.getFebud1(this.form.tubecenter_id);
      }
      if (this.form.tubecenter_id === '') {
        this.errortubegroup = this.$t('normal.error_08') + 'center';
      } else {
        this.errortubegroup = '';
      }
    },
    //获取移管部門的预算编码
    getbud(val) {
      //ADD_FJL   修改人员预算编码
      if (val !== '' && val !== null) {
        this.options1 = [];
        let butinfo = getOrgInfo(val).encoding;
        let dic = this.$store.getters.dictionaryList.filter(item => item.pcode === 'JY002');
        if (dic.length > 0) {
          for (let i = 0; i < dic.length; i++) {
            if (butinfo === dic[i].value1) {
              this.options1.push({
                lable: dic[i].value3,
                value: dic[i].code,
              });
            }
          }
        }
      } else {
        this.form.tubebudgetunit = '';
        this.options1 = [];
      }
      //ADD_FJL  修改人员预算编码
    },
    changeBut(val) {
      this.form.ferrybudgetunit = val;
    },
    getTeamId2(val) {
      this.getOrgInformation1(val);
      if (this.form.tubecenter_id === '') {
        this.errortubegroup = this.$t('normal.error_08') + 'center';
      } else {
        this.errortubegroup = '';
      }
    },
    getOrgInformation1(id) {
      let org = {};
      let treeCom = this.$store.getters.orgs;

      if (id && treeCom.getNode(id)) {
        let node = id;
        let type = treeCom.getNode(id).data.type || 0;
        for (let index = parseInt(type); index >= 1; index--) {
          if (parseInt(type) === index && ![1, 2].includes(parseInt(type))) {
            org.tubecentername = treeCom.getNode(node).data.departmentname;
            org.tubeteam_id = treeCom.getNode(node).data._id;
          }
          if (index === 2) {
            org.tubegroupname = treeCom.getNode(node).data.departmentname;
            org.tubegroup_id = treeCom.getNode(node).data._id;
            this.getbud(org.tubegroup_id);
          }
          if (index === 1) {
            org.tubecentername = treeCom.getNode(node).data.companyname;
            org.tubecenter_id = treeCom.getNode(node).data._id;
          }
          node = treeCom.getNode(node).parent.data._id;
        }
        ({
          tubecentername: this.form.tubecentername,
          tubegroupname: this.form.tubegroupname,
          tubeteamname: this.form.tubeteamname,
          tubecenter_id: this.form.tubecenter_id,
          tubegroup_id: this.form.tubegroup_id,
          tubeteam_id: this.form.tubeteam_id,
        } = org);
      }
    },

    getTubebudgetunit(val) {
      this.form.tubebudgetunit = val;
    },
    workflowState(val) {
      if (val.state === '1') {
        this.form.status = '3';
      } else if (val.state === '2') {
        this.form.status = '4';
      }
      this.buttonClick('update');
    },
    //add-ws-5-20-流程恒展开
    start(val) {
      if (val.state === '0') {
        this.form.status = '2';
      } else if (val.state === '2') {
        this.form.status = '4';
      }
      this.buttonClick('update');
    },
    //add-ws-5-20-流程恒展开
    end() {
      this.form.status = '0';
      this.buttonClick('update');
    },
    deleteRow(index, rows) {
      if (rows.length > 1) {
        rows.splice(index, 1);
      } else {
        this.tableD = [
          {
            notificationid: '',
            softwaretransferid: '',
            management: '',
            assetname: '',
            person: null,
            eafter: null,
            reason: '',
          },
        ];
      }
    },
    // addRow() {
    //   this.tableD.push({
    //     notificationid: '',
    //     softwaretransferid: '',
    //     management: '',
    //     assetname: '',
    //     person: '',
    //     eafter: '',
    //     reason: '',
    //   });
    // },
    paramsTitle() {
      this.$router.push({
        name: 'PFANS1037FormView',
        params: {
          title: 8,
        },
      });
    },
    buttonClick(val) {
      if (val === 'back') {
        this.paramsTitle();
      } else {
        this.$refs['refform'].validate(valid => {
          if (valid) {
            this.loading = true;
            this.baseInfo = {};
            this.form.mobiledate = moment(this.form.mobiledate).format('YYYY-MM-DD');
            this.baseInfo.softwaretransfer = JSON.parse(JSON.stringify(this.form));
            this.baseInfo.notification = [];
            for (let i = 0; i < this.tableD.length; i++) {
              //add-ws-7/2-禅道任务192
              if (this.tableD[i].management == '' && this.tableD[i].assetname == '') {
                this.loading = false;
                Message({
                  message: this.$t('label.PFANS1008FORMVIEW_CHECKERROR'),
                  type: 'error',
                  duration: 5 * 1000,
                });
                return;
              } else {
                //add-ws-7/2-禅道任务192
                if (this.tableD[i].management !== '' || this.tableD[i].assetname !== '' || this.tableD[i].person !== '' ||
                  this.tableD[i].eafter !== '' || this.tableD[i].reason !== '') {
                  this.baseInfo.notification.push(
                    {
                      notificationid: this.tableD[i].notificationid,
                      softwaretransferid: this.tableD[i].softwaretransferid,
                      management: this.tableD[i].management,
                      assetname: this.tableD[i].assetname,
                      person: this.tableD[i].person,
                      eafter: this.tableD[i].eafter,
                      reason: this.tableD[i].reason,
                    },
                  );
                }
              }

            }
            if (this.$route.params._id) {
              this.baseInfo.softwaretransferid = this.$route.params._id;
              this.form.ferrycenter_id = this.ferrycenterorglist;
              this.form.ferrygroup_id = this.ferrygrouporglist;
              this.form.ferryteam_id = this.ferryteamorglist;
              this.form.tubecenter_id = this.tubecenterorglist;
              this.form.tubegroup_id = this.tubegrouporglist;
              this.form.tubeteam_id = this.tubeteamorglist;
              this.$store
                .dispatch('PFANS1008Store/updateSoftwaretransfer', this.baseInfo)
                .then(response => {
                  this.data = response;
                  this.loading = false;
                  if (val !== 'update') {
                    Message({
                      message: this.$t('normal.success_02'),
                      type: 'success',
                      duration: 5 * 1000,
                    });
                    this.paramsTitle();
                  }
                })
                .catch(error => {
                  this.$message.error({
                    message: error,
                    type: 'error',
                    duration: 5 * 1000,
                  });
                  this.loading = false;
                });

            } else {
              this.$store
                .dispatch('PFANS1008Store/insert', this.baseInfo)
                .then(response => {
                  this.data = response;
                  this.loading = false;
                  Message({
                    message: this.$t('normal.success_01'),
                    type: 'success',
                    duration: 5 * 1000,
                  });
                  this.paramsTitle();
                })
                .catch(error => {
                  this.$message.error({
                    message: error,
                    type: 'error',
                    duration: 5 * 1000,
                  });
                  this.loading = false;
                });
            }
          }
        });
      }
    },
  },
};
</script>

<style lang="scss" rel="stylesheet/scss">

</style>
