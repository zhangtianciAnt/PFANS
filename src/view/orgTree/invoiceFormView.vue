<template>
  <div>
    <EasyNormalContainer ref="container" :title="type==='1'?'创建开票信息':'编辑开票信息'">
      <div slot="customize">
        <el-form ref="invoiceform" v-loading="invoiceformloading" :model="invoiceform" class="demo-ruleForm" label-width="8rem"
                 status-icon style="width:80%;margin:5% auto">
          <el-form-item label="公司名称" prop="companyname">
            <span>{{ currentNode.companyname }}</span>
          </el-form-item>
          <el-form-item :rules="[
              { required: true, message: '请输入纳税人识别号', trigger: 'blur' },
              { validator: dutynumberCheck, trigger: 'blur'}]" label="纳税人识别号" prop="dutynumber">
            <el-input v-model="invoiceform.dutynumber" auto-complete="off" placeholder="纳税人识别号"></el-input>
          </el-form-item>
          <el-form-item :rules="[
              { required: true, message: '请输入开户行', trigger: 'blur' }]" label="开户行" prop="bankbranch">
            <el-input v-model="invoiceform.bankbranch" auto-complete="off" placeholder="开户行"></el-input>
          </el-form-item>
          <el-form-item :rules="[
              { required: true, message: '请输入银行账号', trigger: 'blur' },
               { validator: dutynumberCheck, trigger: 'blur'}]" label="银行账号" prop="banknumber">
            <el-input v-model="invoiceform.banknumber" auto-complete="off" placeholder="银行账号"></el-input>
          </el-form-item>
          <el-form-item :rules="[
              { required: true, message: '请输入地址', trigger: 'blur' }]" label="地址" prop="companyaddress">
            <el-input v-model="invoiceform.companyaddress" auto-complete="off" placeholder="地址"></el-input>
          </el-form-item>
          <el-form-item :rules="[
              { required: true, message: '请输入电话', trigger: 'blur' },
              { validator: dutynumberCheck, trigger: 'blur'}]" label="电话" prop="phone">
            <el-input v-model="invoiceform.phone" auto-complete="off" placeholder="电话"></el-input>
          </el-form-item>
          <el-form-item>
            <easy-button-bar :data="buttonList" @buttonClick="buttonClick"></easy-button-bar>
          </el-form-item>
        </el-form>
      </div>
    </EasyNormalContainer>
  </div>
</template>

<script>
import EasyNormalContainer from '@/components/EasyNormalContainer';
import EasyButtonBar from '@/components/EasyButtonBar';
import {validateNumber} from '@/utils/validate';
import {getUUID} from '@/utils/customize';

export default {
  name: 'orgTreeFormView',
  components: {
    EasyNormalContainer,
    EasyButtonBar,
  },
  data() {
    return {
      type: this.$route.params.type,
      currentNode: this.$route.params.currentNode,
      orgTree: this.$route.params.orgTree,
      invoiceform: this.$route.params.invoice,
      invoiceformloading: false,
      buttonList: [
        {key: 'btnSave', name: '保存'},
        {key: 'btnCancel', name: '取消'},
      ],
    };
  },
  methods: {
    submitForm(formName) {
      this.$refs[formName].validate(valid => {
        if (valid) {
          this.insertInvoice();
        } else {
          return false;
        }
      });
    },
    insertInvoice() {
      this.invoiceformloading = true;
      if (!this.currentNode.invoiceinfo) {
        this.$set(this.currentNode, 'invoiceinfo', {});
      }
      if (this.type === '1') {
        this.invoiceform._id = getUUID(36, 16);
      }
      this.currentNode.invoiceinfo = this.invoiceform;
      let data = this.orgTree.data;
      this.$store
        .dispatch('orgTreeStore/saveTree', data[0])
        .then(() => {
          this.invoiceformloading = false;
          this.$refs.container.buttonClick('back');
        })
        .catch(() => {
          this.invoiceformloading = false;
        });
    },
    dutynumberCheck(rule, value, callback) {
      if (validateNumber(value)) {
        callback();
      } else {
        callback(new Error('只可以输入数字！'));
      }
    },
    cancelForm() {
      this.$refs.container.buttonClick('back');
    },
    buttonClick(val) {
      if (val === 'btnSave') {
        this.submitForm('invoiceform');
      } else {
        this.cancelForm();
      }
    },
  },
};
</script>
<style lang='scss'>
</style>

